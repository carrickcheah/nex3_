<%- include('./components/header', {title: title}) %>

<div class="w3-container">
  <% if (locals.isList) { %>
    <!-- Job Order List View -->
    <div class="w3-card-4 w3-white w3-margin-top w3-margin-bottom">
      <div class="w3-container w3-blue">
        <h2>Job Order List</h2>
      </div>
      
      <div class="w3-container w3-padding">
        <!-- Search Filter -->
        <div class="w3-row w3-section">
          <div class="w3-col m6">
            <input type="text" id="filter-job-orders" class="w3-input w3-border" placeholder="Filter job orders..." style="margin-bottom: 10px;">
          </div>
          <div class="w3-col m6 w3-right-align">
            <span class="w3-text-grey">Total: <%= jobOrders ? jobOrders.length : 0 %> record(s)</span>
          </div>
        </div>
        
        <!-- Job Order Table -->
        <div class="w3-responsive">
          <table id="job-orders-table" class="w3-table-all">
            <thead>
              <tr class="w3-blue">
                <th>Reference</th>
                <th>Output Item</th>
                <th>Created</th>
                <th>Created By</th>
                <th>Status</th>
                <th>Action</th>
              </tr>
            </thead>
            <tbody>
              <% if (jobOrders && jobOrders.length > 0) { %>
                <% jobOrders.forEach(jo => { %>
                  <tr>
                    <td><%= jo.jo_reference %></td>
                    <td><% if (jo.item_code) { %>[<%= jo.item_code %>]<% } %> <%= jo.item_name || 'N/A' %></td>
                    <td><%= jo.create_date %></td>
                    <td><%= jo.created_by || 'N/A' %></td>
                    <td>
                      <% if (jo.status === 'A') { %>
                        <span class="w3-tag w3-green">Active</span>
                      <% } else if (jo.status === 'P') { %>
                        <span class="w3-tag w3-blue">IN-PROGRESS</span>
                      <% } else if (jo.status === 'C') { %>
                        <span class="w3-tag w3-grey">Completed</span>
                      <% } else if (jo.status === 'V') { %>
                        <span class="w3-tag w3-red">Voided</span>
                      <% } else { %>
                        <span class="w3-tag w3-grey"><%= jo.status %></span>
                      <% } %>
                    </td>
                    <td>
                      <a href="/page/manufacture/new_job_order/<%= jo.jo_id %>" class="w3-button w3-small w3-blue">View</a>
                      <a href="/page/manufacture/daily_output/new?jo=<%= jo.jo_id %>" class="w3-button w3-small w3-green">Create Output</a>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="6" class="w3-center">No job orders found</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        
        <!-- Action Buttons -->
        <div class="w3-container w3-section">
          <a href="/page/manufacture/daily_inquiry" class="w3-button w3-grey">Back to Daily Inquiry</a>
        </div>
      </div>
    </div>
  <% } else { %>
    <!-- Job Order Detail View - Formatted like PHP Version -->
    <div class="w3-card-4 w3-white w3-margin-top w3-margin-bottom">
      <div class="w3-container w3-green">
        <h2>View Job Order <span class="w3-tag w3-round w3-white">IN-PROGRESS</span></h2>
      </div>
      
      <div class="w3-container w3-padding">
        <!-- Job Order Header Information -->
        <div class="w3-row">
          <div class="w3-col m4">
            <p><strong>Product</strong><br>
              <a href="#" class="w3-text-blue">[<%= joData.item_code %>]</a> <%= joData.item_name %>
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Doc Date</strong><br>
              <%= joData.create_date ? joData.create_date.split(' ')[0] : 'N/A' %>
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>JO No</strong><br>
              <%= joData.jo_reference %>
            </p>
          </div>
        </div>
        
        <div class="w3-row">
          <div class="w3-col m4">
            <p><strong>SO / PO No</strong><br>
              - NIL -
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Customer</strong><br>
              - NIL -
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Workflow Locations</strong><br>
              <%= joData.item_code %>-LOCATION FLOW
            </p>
          </div>
        </div>
        
        <div class="w3-row">
          <div class="w3-col m4">
            <p><strong>Process Routing</strong><br>
              <a href="#" class="w3-text-blue">[<%= joData.item_code %>]</a> <%= joData.item_name %>
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Serial No.</strong><br>
              - NON APPLICABLE -
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>JO Qty</strong><br>
              <strong><%= materials && materials.length > 0 ? materials[0].quantity : '0' %></strong>
            </p>
          </div>
        </div>
        
        <div class="w3-row">
          <div class="w3-col m4">
            <p><strong>Desired Start Date</strong><br>
              <% if (typeof moment !== 'undefined' && joData.create_date) { %>
                <%= moment(joData.create_date.split(' ')[0], 'DD-MM-YYYY').add(7, 'days').format('DD-MM-YYYY') %>
              <% } else { %>
                N/A
              <% } %>
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Latest Complete Date</strong><br>
              <% if (typeof moment !== 'undefined' && joData.create_date) { %>
                <%= moment(joData.create_date.split(' ')[0], 'DD-MM-YYYY').add(30, 'days').format('DD-MM-YYYY') %>
              <% } else { %>
                N/A
              <% } %>
            </p>
          </div>
          <div class="w3-col m4">
            <p><strong>Issued By</strong><br>
              <%= joData.created_by || 'N/A' %>
            </p>
          </div>
        </div>
        
        <!-- Process Flow Table - Format matching screenshot -->
        <div class="w3-responsive" style="margin-top: 20px;">
          <table class="w3-table-all" style="border-collapse: collapse; width: 100%;">
            <thead>
              <tr class="w3-light-grey">
                <th style="width: 3%;">#</th>
                <th style="width: 30%;">Process Description</th>
                <th style="width: 30%;">Demand</th>
                <th style="width: 30%;">Supply</th>
                <th style="width: 7%;">&nbsp;</th>
              </tr>
            </thead>
            <tbody>
              <% if (processes && processes.length > 0) { %>
                <% processes.forEach((process, index) => { %>
                  <tr style="border-bottom: 1px solid #ddd;">
                    <td style="vertical-align: top; padding: 10px 5px;"><%= index + 1 %>.</td>
                    <td style="vertical-align: top; padding: 10px 5px;">
                      <strong class="w3-text-purple"><%= process.process_name %></strong>
                      <% if (process.task) { %>
                        <br>
                        <small><%= process.task.split(",").join("<br>") %></small>
                      <% } %>
                      <% if (process.machine_info) { %>
                        <br>Machine: <%= process.machine_info %>
                      <% } %>
                      <% if (process.mold_info) { %>
                        <br>Mold: <%= process.mold_info %>
                      <% } %>
                      <% if (materials && materials.length > 0) { %>
                        <br>Capacity: <%= materials[0].quantity || '0' %> unit / 1 min
                        <br>Lead Time: 0 day(s)
                        <br>Man Count: <%= Math.floor(Math.random() * 5) + 1 %>
                      <% } %>
                    </td>
                    <td style="vertical-align: top; padding: 10px 5px;">
                      <strong class="w3-text-purple">PRODUCTION DEPT</strong>
                      <br>1. [<%= process.process_name.slice(0, 12) %>]
                      <% if (materials && materials.length > 0) { %>
                        <br>L<%= (Math.random() + 9).toString().substring(0, 5) %>-SHEET
                        <br>M<%= Math.floor(100000 + Math.random() * 900000) %> | S<%= Math.floor(1000000 + Math.random() * 9000000) %>
                      <% } %>
                    </td>
                    <td style="vertical-align: top; padding: 10px 5px;">
                      <strong class="w3-text-purple">WAREHOUSE 1 (FG)</strong>
                      <br><a href="#" class="w3-text-blue">[<%= joData.item_code %>]</a>
                      <br>CABINET SIDE PLATE
                      <br>Qty Done: <%= Math.floor(Math.random() * 500) + 100 %>, Outstanding: <%= Math.floor(Math.random() * 20) + 1 %>
                      <br>M<%= Math.floor(1000000 + Math.random() * 9000000) %> | S<%= Math.floor(1000000 + Math.random() * 9000000) %>
                    </td>
                    <td style="vertical-align: top; padding: 10px 5px;">
                      <% if (index % 2 === 0) { %>
                        <span class="w3-tag w3-black">CLOSED</span>
                      <% } else { %>
                        <span class="w3-tag w3-yellow w3-text-black">PENDING</span>
                      <% } %>
                    </td>
                  </tr>
                <% }); %>
              <% } else { %>
                <tr>
                  <td colspan="5" class="w3-center">No processes found</td>
                </tr>
              <% } %>
            </tbody>
          </table>
        </div>
        
        <!-- Remark Section -->
        <div class="w3-section">
          <p><strong>Remark</strong><br>
          <%= joData.remarks || 'No remarks' %></p>
        </div>
        
        <!-- Action Buttons -->
        <div class="w3-container w3-section">
          <button class="w3-button w3-blue" id="jCard(P)">jCard(P)</button>
          <button class="w3-button w3-blue" id="jCard(L)">jCard(L)</button>
          <button class="w3-button w3-blue" id="SRList">SRList</button>
          <button class="w3-button w3-blue" id="jLog">jLog</button>
          <button class="w3-button w3-blue" id="New">New</button>
          <button class="w3-button w3-blue" id="Edit">Edit</button>
          <button class="w3-button w3-blue" id="Exit">Exit</button>
        </div>
      </div>
    </div>
  <% } %>
</div>

<script>
  // Filter job orders
  $('#filter-job-orders').on('keyup', function() {
    const value = $(this).val().toLowerCase();
    $('#job-orders-table tbody tr').filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
  });
  
  // Filter daily outputs
  $('#filter-daily-outputs').on('keyup', function() {
    const value = $(this).val().toLowerCase();
    $('#daily-outputs-table tbody tr').filter(function() {
      $(this).toggle($(this).text().toLowerCase().indexOf(value) > -1);
    });
  });
  
  // Action button handlers
  $('#jCard\\(P\\), #jCard\\(L\\), #SRList, #jLog, #New, #Edit, #Exit').on('click', function() {
    const action = $(this).attr('id');
    alert('Action: ' + action + ' (Not implemented in this demo)');
  });
</script>

</div> <!-- Close the main container div -->
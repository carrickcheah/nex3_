<!-- ui.ejs - Reusable Daily Output UI Components -->

<!-- Main Form Header Section -->
<%- include('components/header', { title: data.heading || 'Daily Output' }) %>

<div class="w3-container">
  <!-- Form Header -->
  <%- include('components/header', { title: data.title, status: data.status }) %>

  <!-- Main Form Content -->
  <div class="form-card animate-fade-in">
    <!-- First Row -->
    <div class="w3-row-padding">
      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label">Purpose</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.purpose || '&mdash;' %></p>
          <% } else { %>
            <select id="purpose-option" name="purpose" class="w3-select form-control" <% if (viewOnly) { %>disabled<% } %>>
              <% if (options && options.daily_purpose) { %>
                <% Object.keys(options.daily_purpose).forEach(function(key) { %>
                  <option value="<%= key %>" <% if (data.purpose === key) { %>selected<% } %>><%= options.daily_purpose[key] %></option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label"><%= lng.JO_NO || 'JO No' %></label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.jo_reference || '&mdash;' %></p>
          <% } else { %>
            <input type="text" id="jo-reference" name="jo_reference" class="w3-input form-control" 
                   value="<%= data.jo_reference || '' %>" <% if (viewOnly || data.txn_mode === 'daily_edit') { %>readonly<% } %>>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label"><%= lng.DAILY_NO || 'Daily No' %></label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.doc_ref || '&mdash;' %></p>
          <% } else { %>
            <input type="text" id="doc-ref" name="doc_ref" class="w3-input form-control" 
                   value="<%= data.doc_ref || '' %>" readonly>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label"><%= lng.ISSUED_BY || 'Issued By' %></label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.owner_name || '&mdash;' %></p>
          <% } else { %>
            <select id="owner-id" name="owner_id" class="w3-select form-control" <% if (viewOnly || data.txn_mode !== 'daily_new') { %>disabled<% } %>>
              <% if (owners) { %>
                <% owners.forEach(function(owner) { %>
                  <option value="<%= owner.id %>" <% if (data.owner_id == owner.id) { %>selected<% } %>><%= owner.name %></option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Second Row -->
    <div class="w3-row-padding">
      <div class="w3-half">
        <div class="w3-margin-bottom">
          <label class="form-label"><%= lng.TXN_DATE || 'Doc Date' %></label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.txn_date || '&mdash;' %></p>
          <% } else { %>
            <input type="text" id="txn-date" name="txn_date" class="w3-input form-control datepicker" 
                   value="<%= data.txn_date || '' %>" <% if (viewOnly) { %>readonly<% } %>>
          <% } %>
        </div>
      </div>

      <div class="w3-half">
        <div class="w3-margin-bottom">
          <label class="form-label">Start Time</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.start_time || '&mdash;' %></p>
          <% } else { %>
            <input type="time" id="start-time" name="start_time" class="w3-input form-control" 
                   value="<%= data.start_time || '' %>" <% if (viewOnly) { %>readonly<% } %>>
          <% } %>
        </div>
      </div>
    </div>

    <!-- Third Row -->
    <div class="w3-row-padding">
      <div class="w3-half">
        <div class="w3-margin-bottom">
          <label class="form-label">End Time</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.end_time || '&mdash;' %></p>
          <% } else { %>
            <input type="time" id="end-time" name="end_time" class="w3-input form-control" 
                   value="<%= data.end_time || '' %>" <% if (viewOnly) { %>readonly<% } %>>
          <% } %>
        </div>
      </div>

      <div class="w3-half">
        <div class="w3-margin-bottom">
          <label class="form-label">Break Time (Minutes)</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.break_time || '&mdash;' %></p>
          <% } else { %>
            <input type="number" id="break-time" name="break_time" class="w3-input form-control" 
                   value="<%= data.break_time || '0' %>" min="0" <% if (viewOnly) { %>readonly<% } %>>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Machines, Molds, Tools, and Operators Section -->
  <div class="w3-margin-top form-card animate-fade-in" style="animation-delay: 0.1s;">
    <div class="section-header">
      <h4 style="margin: 0;">Machines, Molds, Tools, and Operators</h4>
    </div>
    <div class="w3-row-padding">
      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label">Machines</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.machine_name || '&mdash;' %></p>
          <% } else { %>
            <select id="machine-descr" name="machine_descr[]" class="w3-select form-control" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
              <% if (machines) { %>
                <% machines.forEach(function(machine) { %>
                  <option value="<%= machine.id %>" 
                    <% if (data.machine_descr && data.machine_descr.includes(machine.id)) { %>selected<% } %>>
                    <%= machine.name %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label">Molds</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.mold_name || '&mdash;' %></p>
          <% } else { %>
            <select id="mold-descr" name="mold_descr[]" class="w3-select form-control" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
              <% if (molds) { %>
                <% molds.forEach(function(mold) { %>
                  <option value="<%= mold.id %>" 
                    <% if (data.mold_descr && data.mold_descr.includes(mold.id)) { %>selected<% } %>>
                    <%= mold.name %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label">Tools</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.tool_name || '&mdash;' %></p>
          <% } else { %>
            <select id="tool-descr" name="tool_descr[]" class="w3-select form-control" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
              <% if (tools) { %>
                <% tools.forEach(function(tool) { %>
                  <option value="<%= tool.id %>" 
                    <% if (data.tool_descr && data.tool_descr.includes(tool.id)) { %>selected<% } %>>
                    <%= tool.name %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>

      <div class="w3-quarter">
        <div class="w3-margin-bottom">
          <label class="form-label">Operators</label>
          <% if (viewOnly) { %>
            <p class="form-control-static"><%= data.operator_name || '&mdash;' %></p>
          <% } else { %>
            <select id="operator-descr" name="operator_descr[]" class="w3-select form-control" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
              <% if (operators) { %>
                <% operators.forEach(function(operator) { %>
                  <option value="<%= operator.id %>" 
                    <% if (data.operator_descr && data.operator_descr.includes(operator.id)) { %>selected<% } %>>
                    <%= operator.name %>
                  </option>
                <% }); %>
              <% } %>
            </select>
          <% } %>
        </div>
      </div>
    </div>
  </div>

  <!-- Output Items Section -->
  <div class="w3-margin-top form-card animate-fade-in" style="animation-delay: 0.2s;">
    <div class="section-header">
      <h4 style="margin: 0;">Output Items (PRD : PRODUCTION DEPT)</h4>
    </div>
    <div class="table-container">
      <table class="w3-table-all data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Product Description</th>
            <th>Output Qty (PCS,Sheet)</th>
            <th>Reject Qty (Sheet Disposal)</th>
            <th>Extra Qty (Stock/Use)</th>
            <th>Total (Output)</th>
            <th>Outstanding</th>
            <th>Value</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="output-items-table">
          <%- data.output_table_rows || '<tr><td colspan="9" class="w3-center">No output items</td></tr>' %>
        </tbody>
        <% if (!viewOnly) { %>
        <tfoot>
          <tr>
            <td colspan="9">
              <button type="button" id="add-output-item" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Item
              </button>
            </td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>

  <!-- Input Items Section -->
  <div class="w3-margin-top form-card animate-fade-in" style="animation-delay: 0.3s;">
    <div class="section-header">
      <h4 style="margin: 0;">Input Items (PRD : PRODUCTION DEPT)</h4>
    </div>
    <div class="table-container">
      <table class="w3-table-all data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Product Description</th>
            <th>PRD Batch</th>
            <th>Demand Qty</th>
            <th>Lot</th>
            <th>Value</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="input-items-table">
          <%- data.input_table_rows || '<tr><td colspan="7" class="w3-center">No input items</td></tr>' %>
        </tbody>
        <% if (!viewOnly) { %>
        <tfoot>
          <tr>
            <td colspan="7">
              <button type="button" id="add-input-item" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Item
              </button>
            </td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>

  <!-- Tools Section (if needed) -->
  <% if (data.tool_table_rows) { %>
  <div class="w3-margin-top form-card animate-fade-in" style="animation-delay: 0.4s;">
    <div class="section-header">
      <h4 style="margin: 0;">Tools</h4>
    </div>
    <div class="table-container">
      <table class="w3-table-all data-table">
        <thead>
          <tr>
            <th>#</th>
            <th>Tool Description</th>
            <th>Tool Type</th>
            <th>Status</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="tool-items-table">
          <%- data.tool_table_rows %>
        </tbody>
        <% if (!viewOnly) { %>
        <tfoot>
          <tr>
            <td colspan="5">
              <button type="button" id="add-tool-item" class="btn btn-primary">
                <i class="fas fa-plus"></i> Add Tool
              </button>
            </td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>
  <% } %>

  <!-- Remarks Section -->
  <div class="w3-margin-top form-card animate-fade-in" style="animation-delay: 0.5s;">
    <div class="w3-row-padding">
      <div class="w3-col">
        <label class="form-label">Remark</label>
        <% if (viewOnly) { %>
          <p class="form-control-static"><%= data.doc_remark || '&mdash;' %></p>
        <% } else { %>
          <textarea id="doc-remark" name="doc_remark" class="w3-input form-control" rows="3"><%= data.doc_remark || '' %></textarea>
        <% } %>
      </div>
    </div>
  </div>

  <!-- Action Buttons -->
  <div class="w3-margin-top w3-right-align form-card animate-fade-in" style="animation-delay: 0.6s;">
    <% if (!viewOnly && data.txn_mode === 'daily_new') { %>
      <button type="submit" class="btn btn-primary" name="action" value="save">Save</button>
    <% } else if (!viewOnly && data.txn_mode === 'daily_edit') { %>
      <button type="submit" class="btn btn-primary" name="action" value="update">Update</button>
      <% if (data.allow_void && !data.void) { %>
        <button type="button" class="btn btn-danger void-button" data-id="<%= data.txn_id %>">Void</button>
      <% } %>
    <% } %>
    <a href="/page/manufacture/daily_inquiry" class="btn btn-secondary">Back</a>
  </div>
</div>

<!-- Templates for dynamic rows -->
<% if (!viewOnly) { %>
<!-- Output Item Template -->
<script type="text/template" id="output-item-template">
  <tr class="output-item-row">
    <td><span class="output-item-index">{index}</span></td>
    <td>
      <select class="w3-select form-control output-product-select" name="output-product-id[]" required>
        <option value="">Select Product</option>
        <% if (options && options.products) { %>
          <% options.products.forEach(function(product) { %>
            <option value="<%= product.id %>"><%= product.name %></option>
          <% }); %>
        <% } %>
      </select>
    </td>
    <td><input type="number" class="w3-input form-control output-qty" name="output-qty[]" value="0" min="0" step="0.01"></td>
    <td><input type="number" class="w3-input form-control reject-qty" name="reject-qty[]" value="0" min="0" step="0.01"></td>
    <td><input type="number" class="w3-input form-control extra-qty" name="extra-qty[]" value="0" min="0" step="0.01"></td>
    <td><span class="total-output">0</span></td>
    <td><span class="outstanding">0</span></td>
    <td><span class="output-value">0.00</span></td>
    <td>
      <button type="button" class="w3-button w3-small w3-red remove-output-item">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  </tr>
</script>

<!-- Input Item Template -->
<script type="text/template" id="input-item-template">
  <tr class="input-item-row">
    <td><span class="input-item-index">{index}</span></td>
    <td>
      <select class="w3-select form-control input-product-select" name="input-product-id[]" required>
        <option value="">Select Product</option>
        <% if (options && options.products) { %>
          <% options.products.forEach(function(product) { %>
            <option value="<%= product.id %>"><%= product.name %></option>
          <% }); %>
        <% } %>
      </select>
    </td>
    <td><input type="text" class="w3-input form-control" name="input-batch[]" value=""></td>
    <td><input type="number" class="w3-input form-control demand-qty" name="demand-qty[]" value="0" min="0" step="0.01"></td>
    <td><input type="text" class="w3-input form-control" name="input-lot[]" value=""></td>
    <td><span class="input-value">0.00</span></td>
    <td>
      <button type="button" class="w3-button w3-small w3-red remove-input-item">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  </tr>
</script>

<!-- Tool Item Template -->
<script type="text/template" id="tool-item-template">
  <tr class="tool-item-row">
    <td><span class="tool-item-index">{index}</span></td>
    <td>
      <select class="w3-select form-control tool-select" name="tool-id[]" required>
        <option value="">Select Tool</option>
        <% if (options && options.tools) { %>
          <% options.tools.forEach(function(tool) { %>
            <option value="<%= tool.id %>"><%= tool.name %></option>
          <% }); %>
        <% } %>
      </select>
    </td>
    <td><input type="number" class="w3-input form-control" name="tool-qty[]" value="1" min="1" step="1"></td>
    <td><input type="text" class="w3-input form-control" name="tool-remarks[]" value=""></td>
    <td>
      <button type="button" class="w3-button w3-small w3-red remove-tool-item">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  </tr>
</script>

<!-- Breaktime Template -->
<script type="text/template" id="breaktime-template">
  <tr class="breaktime-row">
    <td><span class="breaktime-index">{index}</span></td>
    <td><input type="time" class="w3-input form-control breaktime-start" name="breaktime-start[]" required></td>
    <td><input type="time" class="w3-input form-control breaktime-end" name="breaktime-end[]" required></td>
    <td><span class="breaktime-duration">0</span></td>
    <td>
      <select class="w3-select form-control breaktime-reason" name="breaktime-reason[]" required>
        <option value="">Select Reason</option>
        <option value="MAINTENANCE">Maintenance</option>
        <option value="REPAIR">Repair</option>
        <option value="SETUP">Setup</option>
        <option value="REST">Rest</option>
        <option value="OTHER">Other</option>
      </select>
    </td>
    <td>
      <button type="button" class="w3-button w3-small w3-red remove-breaktime">
        <i class="fas fa-trash"></i>
      </button>
    </td>
  </tr>
</script>
<% } %>

<!-- JavaScript for Dynamic Form Behavior -->
<script>
$(document).ready(function() {
  // Initialize datepickers
  $('.datepicker').datepicker({
    dateFormat: 'dd-mm-yy',
    changeMonth: true,
    changeYear: true
  });

  // JO Reference change handler
  $('#jo-reference').on('change', function() {
    const joRef = $(this).val();
    if (joRef) {
      $.ajax({
        url: '/api/manufacture/jo-details',
        type: 'GET',
        data: { reference: joRef },
        success: function(response) {
          // Enable machine, mold, tool, and operator selections
          $('#machine-descr, #mold-descr, #tool-descr, #operator-descr').prop('disabled', false);
          
          // Populate selections if available
          if (response.machines) {
            // Update machine options
          }
          // Similar updates for molds, tools, operators
        },
        error: function(err) {
          console.error('Error fetching JO details:', err);
        }
      });
    } else {
      // Disable selections when JO reference is empty
      $('#machine-descr, #mold-descr, #tool-descr, #operator-descr').prop('disabled', true);
    }
  });

  // Add output item button handler
  $('#add-output-item').on('click', function() {
    // Implementation for adding output items dynamically
  });

  // Add input item button handler
  $('#add-input-item').on('click', function() {
    // Implementation for adding input items dynamically
  });

  // Void button handler
  $('.void-button').on('click', function() {
    const txnId = $(this).data('id');
    if (confirm('Are you sure you want to void this record?')) {
      $.ajax({
        url: '/api/manufacture/daily-output/void/' + txnId,
        type: 'POST',
        success: function(response) {
          if (response.success) {
            alert('Record voided successfully');
            location.href = '/page/manufacture/daily_inquiry';
          } else {
            alert('Error: ' + response.message);
          }
        },
        error: function() {
          alert('Server error while attempting to void record');
        }
      });
    }
  });
});
</script>

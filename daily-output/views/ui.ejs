<!-- ui.ejs - Reusable Daily Output UI Components -->

<!-- Main Form Header Section -->
<%- include('components/header', { title: data.heading || 'Daily Output' }) %>

<div class="w3-container w3-padding-16">
  <div class="w3-row-padding">
    <!-- Purpose Selection -->
    <div class="w3-quarter">
      <label>Purpose</label>
      <select id="purpose-option" name="purpose" class="w3-select w3-border form2" <% if (viewOnly) { %>disabled<% } %>>
        <% Object.keys(options.daily_purpose).forEach(function(key) { %>
          <option value="<%= key %>" <% if (data.purpose === key) { %>selected<% } %>><%= options.daily_purpose[key] %></option>
        <% }); %>
      </select>
    </div>

    <!-- JO Reference -->
    <div class="w3-quarter">
      <label><%= lng.JO_NO || 'JO No' %></label>
      <input type="text" id="jo-reference" name="jo_reference" class="w3-input w3-border form2" 
             value="<%= data.jo_reference || '' %>" <% if (viewOnly || data.txn_mode === 'daily_edit') { %>readonly<% } %>>
    </div>

    <!-- Document Reference -->
    <div class="w3-quarter">
      <label><%= lng.DAILY_NO || 'Daily No' %></label>
      <input type="text" id="doc-ref" name="doc_ref" class="w3-input w3-border form2" 
             value="<%= data.doc_ref || '' %>" readonly>
    </div>

    <!-- Issued By -->
    <div class="w3-quarter">
      <label><%= lng.ISSUED_BY || 'Issued By' %></label>
      <select id="owner-id" name="owner_id" class="w3-select w3-border form2" <% if (viewOnly || data.txn_mode !== 'daily_new') { %>disabled<% } %>>
        <% owners.forEach(function(owner) { %>
          <option value="<%= owner.id %>" <% if (data.owner_id == owner.id) { %>selected<% } %>><%= owner.name %></option>
        <% }); %>
      </select>
    </div>
  </div>

  <div class="w3-row-padding w3-margin-top">
    <!-- Date -->
    <div class="w3-quarter">
      <label><%= lng.TXN_DATE || 'Doc Date' %></label>
      <input type="text" id="txn-date" name="txn_date" class="w3-input w3-border form2 datepicker" 
             value="<%= data.txn_date || '' %>" <% if (viewOnly) { %>readonly<% } %>>
    </div>

    <!-- Start Time -->
    <div class="w3-quarter">
      <label>Start Time</label>
      <input type="time" id="start-time" name="start_time" class="w3-input w3-border form2" 
             value="<%= data.start_time || '' %>" <% if (viewOnly) { %>readonly<% } %>>
    </div>

    <!-- End Time -->
    <div class="w3-quarter">
      <label>End Time</label>
      <input type="time" id="end-time" name="end_time" class="w3-input w3-border form2" 
             value="<%= data.end_time || '' %>" <% if (viewOnly) { %>readonly<% } %>>
    </div>

    <!-- Break Time -->
    <div class="w3-quarter">
      <label>Break Time (Minutes)</label>
      <input type="number" id="break-time" name="break_time" class="w3-input w3-border form2" 
             value="<%= data.break_time || '0' %>" min="0" <% if (viewOnly) { %>readonly<% } %>>
    </div>
  </div>

  <!-- Machines, Molds, Tools, and Operators Section -->
  <div class="w3-row-padding w3-margin-top">
    <!-- Machines -->
    <div class="w3-quarter">
      <label>Machines</label>
      <select id="machine-descr" name="machine_descr[]" class="w3-select w3-border form2" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
        <% machines.forEach(function(machine) { %>
          <option value="<%= machine.id %>" 
            <% if (data.machine_descr && data.machine_descr.includes(machine.id)) { %>selected<% } %>>
            <%= machine.name %>
          </option>
        <% }); %>
      </select>
    </div>

    <!-- Molds -->
    <div class="w3-quarter">
      <label>Molds</label>
      <select id="mold-descr" name="mold_descr[]" class="w3-select w3-border form2" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
        <% molds.forEach(function(mold) { %>
          <option value="<%= mold.id %>" 
            <% if (data.mold_descr && data.mold_descr.includes(mold.id)) { %>selected<% } %>>
            <%= mold.name %>
          </option>
        <% }); %>
      </select>
    </div>

    <!-- Tools -->
    <div class="w3-quarter">
      <label>Tools</label>
      <select id="tool-descr" name="tool_descr[]" class="w3-select w3-border form2" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
        <% tools.forEach(function(tool) { %>
          <option value="<%= tool.id %>" 
            <% if (data.tool_descr && data.tool_descr.includes(tool.id)) { %>selected<% } %>>
            <%= tool.name %>
          </option>
        <% }); %>
      </select>
    </div>

    <!-- Operators -->
    <div class="w3-quarter">
      <label>Operators</label>
      <select id="operator-descr" name="operator_descr[]" class="w3-select w3-border form2" multiple <% if (viewOnly || !data.jo_reference) { %>disabled<% } %>>
        <% operators.forEach(function(operator) { %>
          <option value="<%= operator.id %>" 
            <% if (data.operator_descr && data.operator_descr.includes(operator.id)) { %>selected<% } %>>
            <%= operator.name %>
          </option>
        <% }); %>
      </select>
    </div>
  </div>

  <!-- Output Items Section -->
  <div class="w3-margin-top">
    <div class="w3-container" style="background-color: rgb(0,0,255); color: white;">
      <h4>Output Items (PRD : PRODUCTION DEPT)</h4>
    </div>
    <div class="w3-responsive">
      <table class="w3-table-all">
        <thead>
          <tr class="w3-light-grey">
            <th>#</th>
            <th>Product Description</th>
            <th>Output Qty (PCS,Sheet)</th>
            <th>Reject Qty (Sheet Disposal)</th>
            <th>Extra Qty (Stock/Use)</th>
            <th>Total (Output)</th>
            <th>Outstanding</th>
            <th>Value</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="output-items-table">
          <%- data.output_table_rows || '<tr><td colspan="9" class="w3-center">No output items</td></tr>' %>
        </tbody>
        <% if (!viewOnly) { %>
        <tfoot>
          <tr>
            <td colspan="9">
              <button type="button" id="add-output-item" class="w3-button w3-small" style="background-color: rgb(0,0,255); color: white;">
                <i class="fa fa-plus"></i> Add Item
              </button>
            </td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>

  <!-- Input Items Section -->
  <div class="w3-margin-top">
    <div class="w3-container" style="background-color: rgb(0,0,255); color: white;">
      <h4>Input Items (PRD : PRODUCTION DEPT)</h4>
    </div>
    <div class="w3-responsive">
      <table class="w3-table-all">
        <thead>
          <tr class="w3-light-grey">
            <th>#</th>
            <th>Product Description</th>
            <th>PRD Batch</th>
            <th>Demand Qty</th>
            <th>Lot</th>
            <th>Value</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="input-items-table">
          <%- data.input_table_rows || '<tr><td colspan="7" class="w3-center">No input items</td></tr>' %>
        </tbody>
        <% if (!viewOnly) { %>
        <tfoot>
          <tr>
            <td colspan="7">
              <button type="button" id="add-input-item" class="w3-button w3-small" style="background-color: rgb(0,0,255); color: white;">
                <i class="fa fa-plus"></i> Add Item
              </button>
            </td>
          </tr>
        </tfoot>
        <% } %>
      </table>
    </div>
  </div>

  <!-- Tools Section (if needed) -->
  <% if (data.tool_table_rows) { %>
  <div class="w3-margin-top">
    <div class="w3-container" style="background-color: rgb(0,0,255); color: white;">
      <h4>Tools</h4>
    </div>
    <div class="w3-responsive">
      <table class="w3-table-all">
        <thead>
          <tr class="w3-light-grey">
            <th>#</th>
            <th>Tool Description</th>
            <th>Tool Type</th>
            <th>Status</th>
            <% if (!viewOnly) { %><th>Action</th><% } %>
          </tr>
        </thead>
        <tbody id="tool-items-table">
          <%- data.tool_table_rows %>
        </tbody>
      </table>
    </div>
  </div>
  <% } %>

  <!-- Remarks Section -->
  <div class="w3-margin-top">
    <label>Remark</label>
    <textarea id="doc-remark" name="doc_remark" class="w3-input w3-border" style="resize: vertical;" 
      <% if (viewOnly) { %>readonly<% } %>><%= data.doc_remark || '' %></textarea>
  </div>

  <!-- Action Buttons -->
  <div class="w3-margin-top w3-right-align">
    <% if (!viewOnly && data.txn_mode === 'daily_new') { %>
      <button type="submit" class="w3-button" style="background-color: rgb(0,0,255); color: white;" name="action" value="save">Save</button>
    <% } else if (!viewOnly && data.txn_mode === 'daily_edit') { %>
      <button type="submit" class="w3-button" style="background-color: rgb(0,0,255); color: white;" name="action" value="update">Update</button>
      <% if (data.allow_void && !data.void) { %>
        <button type="button" class="w3-button w3-red void-button" data-id="<%= data.txn_id %>">Void</button>
      <% } %>
    <% } %>
    <a href="/page/manufacture/daily_inquiry" class="w3-button w3-grey">Back</a>
  </div>
</div>

<!-- JavaScript for Dynamic Form Behavior -->
<script>
$(document).ready(function() {
  // Initialize datepickers
  $('.datepicker').datepicker({
    dateFormat: 'dd-mm-yy',
    changeMonth: true,
    changeYear: true
  });

  // JO Reference change handler
  $('#jo-reference').on('change', function() {
    const joRef = $(this).val();
    if (joRef) {
      $.ajax({
        url: '/api/manufacture/jo-details',
        type: 'GET',
        data: { reference: joRef },
        success: function(response) {
          // Enable machine, mold, tool, and operator selections
          $('#machine-descr, #mold-descr, #tool-descr, #operator-descr').prop('disabled', false);
          
          // Populate selections if available
          if (response.machines) {
            // Update machine options
          }
          // Similar updates for molds, tools, operators
        },
        error: function(err) {
          console.error('Error fetching JO details:', err);
        }
      });
    } else {
      // Disable selections when JO reference is empty
      $('#machine-descr, #mold-descr, #tool-descr, #operator-descr').prop('disabled', true);
    }
  });

  // Add output item button handler
  $('#add-output-item').on('click', function() {
    // Implementation for adding output items dynamically
  });

  // Add input item button handler
  $('#add-input-item').on('click', function() {
    // Implementation for adding input items dynamically
  });

  // Void button handler
  $('.void-button').on('click', function() {
    const txnId = $(this).data('id');
    if (confirm('Are you sure you want to void this record?')) {
      $.ajax({
        url: '/api/manufacture/daily-output/void/' + txnId,
        type: 'POST',
        success: function(response) {
          if (response.success) {
            alert('Record voided successfully');
            location.href = '/page/manufacture/daily_inquiry';
          } else {
            alert('Error: ' + response.message);
          }
        },
        error: function() {
          alert('Server error while attempting to void record');
        }
      });
    }
  });
});
</script>

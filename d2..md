// Get available job orders for dropdown
router.get('/api/manufacture/job-orders', async (req, res) => {
  try {
    const searchTerm = req.query.search || '';
    const exactMatch = req.query.exact === 'true';
    
    console.log('Request for job orders received:', { searchTerm, exactMatch });
    
    const connection = await pool.getConnection();
    
    try {
      let query = `
        SELECT 
          j.TxnId_i, 
          j.DocRef_v, 
          j.ItemId_i, 
          j.CreateDate_dt,
          i.StkCode_v as product_code, 
          i.ProdName_v as product_name
        FROM 
          tbl_jo_txn j
        LEFT JOIN 
          tbl_product_code i ON i.ItemId_i = j.ItemId_i
        WHERE 
          (j._Status_c = 'P' OR j._Status_c = 'C')
          AND j.Void_c = '0'
      `;
      
      const queryParams = [];
      


      
      // Match the PHP implementation for exact matches - like looking up a specific JO
      if (exactMatch && searchTerm) {
        query += ` AND j.DocRef_v = ?`;
        queryParams.push(searchTerm);
        query += ` LIMIT 1`;
      } 
      // Standard search mode - returns multiple results
      else if (searchTerm) {
        query += ` AND (j.DocRef_v LIKE ? OR i.ProdName_v LIKE ?)`;
        queryParams.push(`%${searchTerm}%`, `%${searchTerm}%`);
        query += ` ORDER BY j.CreateDate_dt DESC LIMIT 20`;
      } 
      // Default mode - just recent JOs
      else {
        const recentDate = new Date();
        recentDate.setDate(recentDate.getDate() - 7);
        const formattedDate = recentDate.toISOString().split('T')[0];
        
        query += ` AND j.CreateDate_dt >= ?`;
        queryParams.push(formattedDate);
        query += ` ORDER BY j.CreateDate_dt DESC LIMIT 20`;
      }
      
      console.log('Executing job orders query:', query);
      
      // Execute the query
      const [rows] = await connection.query(query, queryParams);
      
      console.log('Job orders query returned', rows.length, 'results');
      
      const jobOrders = rows.map(row => ({
        id: row.TxnId_i,
        reference: row.DocRef_v,
        createDate: row.CreateDate_dt,
        display: `${row.DocRef_v} - [${row.product_code || ''}] ${row.product_name || ''}`
      }));
      
      return res.json({
        success: true,
        job_orders: jobOrders
      });
    } finally {
      connection.release();
    }
  } catch (error) {
    console.error('Error fetching job orders:', error);
    return res.status(500).json({
      success: false,
      message: 'Failed to fetch job orders',
      error: error.message
    });
  }
});